import { Injectable, computed, signal } from '@angular/core';

type Language = 'es' | 'en';

type TranslationMap = Record<string, string>;

const STORAGE_KEY = 'app.lang';

const translations: Record<Language, TranslationMap> = {
  en: {
    'app.brandTitle': 'Family Budget',
    'app.brandSubtitle': 'Insights',
    'app.footer': 'Family Budget Insights',
    'nav.dashboard': 'Dashboard',
    'nav.history': 'History',
    'nav.categories': 'Categories',
    'nav.reports': 'Reports',
    'nav.analysis': 'Analysis',
    'nav.settings': 'Settings',
    'header.dashboardSubtitle': 'General overview of your family spending',
    'header.historySubtitle': 'Detailed transaction logs',
    'header.analysisSubtitle': 'Category spending insights',
    'header.categoriesSubtitle': 'Manage your family categories',
    'header.searchPlaceholder': 'Search transactions...',
    'header.monthOct2023': 'October 2023',
    'kpi.totalSpending': 'Total Spending',
    'kpi.vsLastMonth': 'vs Last Month',
    'kpi.topCategory': 'Top Category',
    'kpi.totalSpendingRange': 'Current period',
    'kpi.totalSpendingRangeDynamic': '{{start}} - {{end}}',
    'kpi.saved': 'Saved $580',
    'kpi.spendingLess': "Great job! You're spending less.",
    'kpi.deltaUp': 'Your spending increased vs previous period.',
    'kpi.deltaDown': "Great job! You're spending less.",
    'kpi.deltaFlat': 'No variation vs previous period.',
    'kpi.topCategoryName': 'Groceries',
    'kpi.topCategoryShare': 'Top category share',
    'kpi.topCategoryShareDynamic': '{{percentage}}% of total spending',
    'chart.spendingByCategory': 'Spending by Category',
    'chart.viewDetails': 'View Details',
    'chart.dailyTrend': 'Daily Spending Trend',
    'chart.avgPerDay': 'Avg $140/day',
    'chart.avgPerDayValue': 'Avg {{amount}}/day',
    'table.recentExpenses': 'Recent Expenses',
    'table.filter': 'Filter',
    'table.export': 'Export',
    'table.viewAll': 'View All Transactions',
    'table.date': 'Date',
    'table.description': 'Description',
    'table.category': 'Category',
    'table.amount': 'Amount',
    'history.breadcrumb': 'Dashboard',
    'history.title': 'Detailed Expense History',
    'history.subtitle': 'View and manage all your family expenses captured from WhatsApp.',
    'history.exportCsv': 'Export CSV',
    'history.searchPlaceholder': "Search messages (e.g. 'pizza')...",
    'history.filterDate': 'Date Range',
    'history.filterCategory': 'Category',
    'history.filterCategoryAll': 'All',
    'history.filterStatus': 'Status',
    'history.moreFilters': 'More Filters',
    'history.range.last7': 'Last 7 days',
    'history.range.last30': 'Last 30 days',
    'history.range.thisMonth': 'This month',
    'history.range.lastMonth': 'Last month',
    'history.table.originalMessage': 'Original Message',
    'history.table.interpretedAmount': 'Interpreted Amount',
    'history.table.status': 'Status',
    'history.table.actions': 'Actions',
    'history.rowsPerPage': 'Rows per page',
    'history.paginationLabel': 'Records',
    'history.paginationLabelDynamic': '{{count}} records',
    'analysis.breadcrumbHighlight': 'Analysis',
    'analysis.title': 'Spending Analysis',
    'analysis.subtitle': 'Detailed breakdown of your family expenses.',
    'analysis.dateRange': 'Date range',
    'analysis.dateRangeDynamic': '{{start}} - {{end}}',
    'analysis.totalSpending': 'Total Spending',
    'analysis.vsLastPeriod': 'vs last period',
    'analysis.vsLastPeriodDynamic': '{{percent}}% vs previous period',
    'analysis.toggleMonthly': 'Monthly',
    'analysis.toggleWeekly': 'Weekly',
    'analysis.insight.pattern': 'Pattern',
    'analysis.insight.topMerchant': 'Top Merchant',
    'analysis.insight.average': 'Average',
    'analysis.insight.budget': 'Budget',
    'analysis.insight.patternText': 'Spending is 15% higher on weekends compared to weekdays.',
    'analysis.insight.topMerchantText': 'Whole Foods accounts for 40% of total category spend.',
    'analysis.insight.averageText': 'Average transaction size is $85.00, slightly above average.',
    'analysis.insight.budgetText': 'You are currently $120 under your monthly budget.',
    'analysis.breakdownTitle': 'Transaction Breakdown',
    'analysis.breakdownDate': 'Date',
    'analysis.breakdownMerchant': 'Merchant',
    'analysis.breakdownSubCategory': 'Sub-category',
    'analysis.breakdownAmount': 'Amount',
    'analysis.breakdownFooter': 'Transactions',
    'analysis.breakdownFooterDynamic': 'Showing {{count}} transactions',
    'category.groceries': 'Groceries',
    'category.transport': 'Transport',
    'category.utilities': 'Utilities',
    'category.entertainment': 'Entertainment',
    'category.unassigned': 'Unassigned',
    'category.housing': 'Housing',
    'category.food': 'Food',
    'category.util': 'Util',
    'category.ent': 'Ent',
    'category.shop': 'Shop',
    'category.snacks': 'Snacks',
    'category.household': 'Household',
    'status.confirmed': 'Confirmed',
    'status.pending': 'Pending',
    'status.flagged': 'Flagged',
    'placeholder.underDevelopment': 'Under Development',
    'placeholder.moduleSoon': 'The {{module}} module will be available soon.',
    'placeholder.backToDashboard': 'Back to Dashboard',
    'categories.createTitle': 'Create category',
    'categories.editTitle': 'Edit category',
    'categories.name': 'Name',
    'categories.description': 'Description',
    'categories.create': 'Create',
    'categories.update': 'Update',
    'categories.clear': 'Clear',
    'categories.listTitle': 'My categories',
    'categories.refresh': 'Refresh',
    'categories.empty': 'No categories yet.',
    'categories.noDescription': 'No description',
    'categories.edit': 'Edit',
    'categories.delete': 'Delete',
    'categories.errorLoad': 'Could not load categories.',
    'categories.errorSave': 'Could not save category.',
    'categories.errorDelete': 'Could not delete category.',
    'profile.plan': 'Pro Plan',
    'lang.toggle': 'ES',
    'login.title': 'Sign in',
    'login.subtitle': 'Enter your phone to receive a verification code.',
    'login.phone': 'Phone',
    'login.code': 'Verification code',
    'login.sendCode': 'Send code',
    'login.verify': 'Verify',
    'login.loading': 'Loading...',
    'login.errorPhoneNotFound': 'Phone not found.',
    'login.errorInvalidCode': 'Invalid code. Try 123456.'
  },
  es: {
    'app.brandTitle': 'Presupuesto Familiar',
    'app.brandSubtitle': 'Insights',
    'app.footer': 'Family Budget Insights',
    'nav.dashboard': 'Dashboard',
    'nav.history': 'Historial',
    'nav.categories': 'Categorias',
    'nav.reports': 'Reportes',
    'nav.analysis': 'Analisis',
    'nav.settings': 'Configuracion',
    'header.dashboardSubtitle': 'Resumen general de gastos familiares',
    'header.historySubtitle': 'Registro detallado de transacciones',
    'header.analysisSubtitle': 'Insights por categoria',
    'header.categoriesSubtitle': 'Gestiona las categorías de tu familia',
    'header.searchPlaceholder': 'Buscar transacciones...',
    'header.monthOct2023': 'Octubre 2023',
    'kpi.totalSpending': 'Gasto Total',
    'kpi.vsLastMonth': 'vs Mes Anterior',
    'kpi.topCategory': 'Categoria Principal',
    'kpi.totalSpendingRange': 'Período actual',
    'kpi.totalSpendingRangeDynamic': '{{start}} - {{end}}',
    'kpi.saved': 'Ahorro $580',
    'kpi.spendingLess': 'Excelente! Estás gastando menos.',
    'kpi.deltaUp': 'Tu gasto aumentó vs el período anterior.',
    'kpi.deltaDown': 'Excelente! Estás gastando menos.',
    'kpi.deltaFlat': 'Sin variación vs período anterior.',
    'kpi.topCategoryName': 'Supermercado',
    'kpi.topCategoryShare': 'Participación de categoría',
    'kpi.topCategoryShareDynamic': '{{percentage}}% del gasto total',
    'chart.spendingByCategory': 'Gasto por categoria',
    'chart.viewDetails': 'Ver detalle',
    'chart.dailyTrend': 'Tendencia diaria de gasto',
    'chart.avgPerDay': 'Promedio $140/dia',
    'chart.avgPerDayValue': 'Promedio {{amount}}/día',
    'table.recentExpenses': 'Gastos recientes',
    'table.filter': 'Filtrar',
    'table.export': 'Exportar',
    'table.viewAll': 'Ver todas las transacciones',
    'table.date': 'Fecha',
    'table.description': 'Descripcion',
    'table.category': 'Categoria',
    'table.amount': 'Monto',
    'history.breadcrumb': 'Dashboard',
    'history.title': 'Historial detallado de gastos',
    'history.subtitle': 'Consulta y administra todos los gastos familiares capturados desde WhatsApp.',
    'history.exportCsv': 'Exportar CSV',
    'history.searchPlaceholder': "Buscar mensajes (ej. 'pizza')...",
    'history.filterDate': 'Rango de fecha',
    'history.filterCategory': 'Categoria',
    'history.filterCategoryAll': 'Todas',
    'history.filterStatus': 'Estado',
    'history.moreFilters': 'Mas filtros',
    'history.range.last7': 'Ultimos 7 dias',
    'history.range.last30': 'Ultimos 30 dias',
    'history.range.thisMonth': 'Este mes',
    'history.range.lastMonth': 'Mes anterior',
    'history.table.originalMessage': 'Mensaje original',
    'history.table.interpretedAmount': 'Monto interpretado',
    'history.table.status': 'Estado',
    'history.table.actions': 'Acciones',
    'history.rowsPerPage': 'Filas por pagina',
    'history.paginationLabel': 'Registros',
    'history.paginationLabelDynamic': '{{count}} registros',
    'analysis.breadcrumbHighlight': 'Análisis',
    'analysis.title': 'Análisis de gastos',
    'analysis.subtitle': 'Desglose detallado de los gastos familiares.',
    'analysis.dateRange': 'Rango de fechas',
    'analysis.dateRangeDynamic': '{{start}} - {{end}}',
    'analysis.totalSpending': 'Gasto total',
    'analysis.vsLastPeriod': 'vs período anterior',
    'analysis.vsLastPeriodDynamic': '{{percent}}% vs período anterior',
    'analysis.toggleMonthly': 'Mensual',
    'analysis.toggleWeekly': 'Semanal',
    'analysis.insight.pattern': 'Patron',
    'analysis.insight.topMerchant': 'Comercio top',
    'analysis.insight.average': 'Promedio',
    'analysis.insight.budget': 'Presupuesto',
    'analysis.insight.patternText': 'El gasto es 15% mayor en fines de semana que en dias de semana.',
    'analysis.insight.topMerchantText': 'Whole Foods representa 40% del gasto total en la categoria.',
    'analysis.insight.averageText': 'El ticket promedio es $85.00, ligeramente por encima del promedio.',
    'analysis.insight.budgetText': 'Estas $120 por debajo de tu presupuesto mensual.',
    'analysis.breakdownTitle': 'Desglose de transacciones',
    'analysis.breakdownDate': 'Fecha',
    'analysis.breakdownMerchant': 'Comercio',
    'analysis.breakdownSubCategory': 'Subcategoria',
    'analysis.breakdownAmount': 'Monto',
    'analysis.breakdownFooter': 'Transacciones',
    'analysis.breakdownFooterDynamic': 'Mostrando {{count}} transacciones',
    'category.groceries': 'Supermercado',
    'category.transport': 'Transporte',
    'category.utilities': 'Servicios',
    'category.entertainment': 'Entretenimiento',
    'category.unassigned': 'Sin asignar',
    'category.housing': 'Vivienda',
    'category.food': 'Comida',
    'category.util': 'Serv',
    'category.ent': 'Ent',
    'category.shop': 'Compras',
    'category.snacks': 'Snacks',
    'category.household': 'Hogar',
    'status.confirmed': 'Confirmado',
    'status.pending': 'Pendiente',
    'status.flagged': 'Marcado',
    'placeholder.underDevelopment': 'En desarrollo',
    'placeholder.moduleSoon': 'El modulo {{module}} estara disponible pronto.',
    'placeholder.backToDashboard': 'Volver al dashboard',
    'categories.createTitle': 'Crear categoría',
    'categories.editTitle': 'Editar categoría',
    'categories.name': 'Nombre',
    'categories.description': 'Descripción',
    'categories.create': 'Crear',
    'categories.update': 'Actualizar',
    'categories.clear': 'Limpiar',
    'categories.listTitle': 'Mis categorías',
    'categories.refresh': 'Recargar',
    'categories.empty': 'Aún no hay categorías.',
    'categories.noDescription': 'Sin descripción',
    'categories.edit': 'Editar',
    'categories.delete': 'Eliminar',
    'categories.errorLoad': 'No se pudieron cargar las categorías.',
    'categories.errorSave': 'No se pudo guardar la categoría.',
    'categories.errorDelete': 'No se pudo eliminar la categoría.',
    'profile.plan': 'Plan Pro',
    'lang.toggle': 'EN',
    'login.title': 'Iniciar sesión',
    'login.subtitle': 'Ingresa tu teléfono para recibir el código de verificación.',
    'login.phone': 'Teléfono',
    'login.code': 'Código de verificación',
    'login.sendCode': 'Enviar código',
    'login.verify': 'Verificar',
    'login.loading': 'Cargando...',
    'login.errorPhoneNotFound': 'No existe un usuario con ese teléfono.',
    'login.errorInvalidCode': 'Código inválido. Prueba con 123456.'
  }
};

@Injectable({ providedIn: 'root' })
export class I18nService {
  private readonly languageSignal = signal<Language>(this.loadLanguage());
  readonly language = this.languageSignal.asReadonly();
  readonly isSpanish = computed(() => this.languageSignal() === 'es');

  setLanguage(language: Language): void {
    this.languageSignal.set(language);
    this.saveLanguage(language);
  }

  toggleLanguage(): void {
    this.setLanguage(this.languageSignal() === 'es' ? 'en' : 'es');
  }

  t(key: string, params?: Record<string, string>): string {
    const current = translations[this.languageSignal()][key] ?? translations.en[key] ?? key;
    if (!params) {
      return current;
    }
    return Object.entries(params).reduce(
      (text, [paramKey, paramValue]) => text.replace(`{{${paramKey}}}`, paramValue),
      current
    );
  }

  private loadLanguage(): Language {
    if (typeof localStorage === 'undefined') {
      return 'es';
    }
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored === 'en' || stored === 'es' ? stored : 'es';
  }

  private saveLanguage(language: Language): void {
    if (typeof localStorage === 'undefined') {
      return;
    }
    localStorage.setItem(STORAGE_KEY, language);
  }
}
