<div class="page">
  <div class="page__inner history">
    <nav class="breadcrumbs">
      <a routerLink="/dashboard">{{ 'history.breadcrumb' | translate }}</a>
      <span class="material-symbols-outlined">chevron_right</span>
      <span class="current">{{ 'nav.history' | translate }}</span>
    </nav>

    <div class="history__title">
      <div>
        <h1>{{ 'history.title' | translate }}</h1>
        <p>{{ 'history.subtitle' | translate }}</p>
      </div>
      <button class="history__export" type="button">
        <span class="material-symbols-outlined">download</span>
        {{ 'history.exportCsv' | translate }}
      </button>
    </div>

    <div class="history__toolbar">
      <div class="history__search">
        <span class="material-symbols-outlined">search</span>
        <input
          type="text"
          [placeholder]="'history.searchPlaceholder' | translate"
          [(ngModel)]="searchTerm"
          (keyup.enter)="applyFilters()"
        />
        <button class="history__search-filter" type="button" aria-label="Filters" (click)="applyFilters()">
          <span class="material-symbols-outlined">tune</span>
        </button>
      </div>
      <div class="history__filters">
        <label class="history__select">
          <span>{{ 'history.filterDate' | translate }}</span>
          <select [(ngModel)]="selectedDateRange">
            <option *ngFor="let option of dateRangeOptions" [value]="option.value">
              {{ option.labelKey | translate }}
            </option>
          </select>
        </label>
        <label class="history__select">
          <span>{{ 'history.filterCategory' | translate }}</span>
          <select [(ngModel)]="selectedCategory">
            <option value="">{{ 'history.filterCategoryAll' | translate }}</option>
            <option *ngFor="let option of (categoryOptions$ | async) ?? []" [value]="option">
              {{ option }}
            </option>
          </select>
        </label>
        <button class="history__filters-more" type="button" (click)="applyFilters()">
          <span class="material-symbols-outlined">filter_list</span>
          {{ 'table.filter' | translate }}
        </button>
        <button class="history__filters-more" type="button" (click)="clearFilters()">
          <span class="material-symbols-outlined">close</span>
          {{ 'categories.clear' | translate }}
        </button>
      </div>
    </div>

    <div class="history__table" *ngIf="transactions$ | async as transactions">
      <table>
        <thead>
          <tr>
            <th>{{ 'table.date' | translate }}</th>
            <th>{{ 'history.table.originalMessage' | translate }}</th>
            <th>{{ 'history.table.interpretedAmount' | translate }}</th>
            <th>{{ 'table.category' | translate }}</th>
            <th class="text-right">{{ 'history.table.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of transactions">
            <td>
              <div class="date">
                <div class="date__main">{{ tx.date | date: 'MMM dd, yyyy' }}</div>
                <div class="date__sub">{{ tx.date | date: 'HH:mm' }}</div>
              </div>
            </td>
            <td>
              <div class="message">
                <span class="material-symbols-outlined fill-icon">chat</span>
                <p>"{{ tx.description }}"</p>
              </div>
            </td>
            <td>
              <span class="amount">{{ formatExpenseAmount(tx) }}</span>
            </td>
            <td>
              <span class="category-chip">
                <span class="material-symbols-outlined">
                  {{ tx.category === 'Groceries' ? 'restaurant' : tx.category === 'Utilities' ? 'bolt' : tx.category === 'Entertainment' ? 'movie' : 'help' }}
                </span>
                {{ getCategoryLabelKey(tx.category) | translate }}
              </span>
            </td>
            <td class="text-right">
              <div class="row-actions">
                <select
                  class="row-actions__select"
                  [ngModel]="selectedCategoryByExpenseId[tx._id ?? ''] || tx.category"
                  (ngModelChange)="onCategoryChange(tx._id, $event)"
                  [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
                >
                  <option *ngFor="let option of (categoryOptions$ | async) ?? []" [value]="option">
                    {{ option }}
                  </option>
                </select>

                <button
                  class="row-action"
                  type="button"
                  (click)="reassignCategory(tx)"
                  [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
                  title="Asociar"
                >
                  <span class="material-symbols-outlined">sync_alt</span>
                </button>

                <button
                  class="row-action row-action--danger"
                  type="button"
                  (click)="deleteExpense(tx)"
                  [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
                  title="Eliminar"
                >
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="history__table-footer">
        <div class="rows-per-page">
          {{ 'history.rowsPerPage' | translate }}:
          <select>
            <option>10</option>
            <option>25</option>
          </select>
        </div>
        <div class="pagination">
          <span *ngIf="transactionsCount$ | async as count">
            {{ 'history.paginationLabelDynamic' | translate: { count: count.toString() } }}
          </span>
          <div class="pagination__buttons">
            <button type="button" disabled>
              <span class="material-symbols-outlined">chevron_left</span>
            </button>
            <button type="button">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="history__list" *ngIf="transactions$ | async as transactions">
      <article class="history__list-item" *ngFor="let tx of transactions">
        <div class="history__list-header">
          <div class="history__list-date">
            <div class="date__main">{{ tx.date | date: 'MMM dd, yyyy' }}</div>
            <div class="date__sub">{{ tx.date | date: 'HH:mm' }}</div>
          </div>
          <div class="history__list-amount">{{ formatExpenseAmount(tx) }}</div>
        </div>
        <div class="message">
          <span class="material-symbols-outlined fill-icon">chat</span>
          <p>"{{ tx.description }}"</p>
        </div>
        <div class="history__list-meta">
          <span class="category-chip">
            <span class="material-symbols-outlined">
              {{ tx.category === 'Groceries' ? 'restaurant' : tx.category === 'Utilities' ? 'bolt' : tx.category === 'Entertainment' ? 'movie' : 'help' }}
            </span>
            {{ getCategoryLabelKey(tx.category) | translate }}
          </span>
        </div>

        <div class="row-actions row-actions--mobile">
          <select
            class="row-actions__select"
            [ngModel]="selectedCategoryByExpenseId[tx._id ?? ''] || tx.category"
            (ngModelChange)="onCategoryChange(tx._id, $event)"
            [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
          >
            <option *ngFor="let option of (categoryOptions$ | async) ?? []" [value]="option">
              {{ option }}
            </option>
          </select>

          <button
            class="row-action"
            type="button"
            (click)="reassignCategory(tx)"
            [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
            title="Asociar"
          >
            <span class="material-symbols-outlined">sync_alt</span>
          </button>

          <button
            class="row-action row-action--danger"
            type="button"
            (click)="deleteExpense(tx)"
            [disabled]="updatingExpenseId === tx._id || deletingExpenseId === tx._id"
            title="Eliminar"
          >
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </article>
    </div>
  </div>
</div>
